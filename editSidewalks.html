<html>
<head>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css">
	<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
	<script src="sidewalks.js"></script>
	
	<script>
		var map;
		var mapView;
		var satView;
		var showSat;
		var lineGroup;
		
		var blueColor = ['aqua', 'blue'];
		var redColor = ['crimson', 'red'];
		
		function initMap()
		{
			map = L.map('map', {
				center: [35.9738346, -78.8982177],
				zoom: 16,
				minZoom: 15,
				zoomControl: false
			});
		
			map.removeControl(map.attributionControl);
		
			mapView = L.tileLayer('https://maps.heigit.org/openmapsurfer/tiles/roads/webmercator/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: 'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			});

			satView = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom: 20,
				attribution: 'Imagery Â© <a href="https://www.mapbox.com/" target="_blank">Mapbox</a>',
				id: 'mapbox.satellite'
			});
		
			map.addLayer(mapView);
			
			showSat = true;
			
			showEdges();
		}
		
		function showEdges()
		{
			var polylines = [];
			
			for(var i = 0; i < edges.length; i++)
			{
				var sidewalk1 = sidewalks[edges[i][0]];
				var sidewalk2 = sidewalks[edges[i][1]];
			
				var newline;
				
				var lineColor = (edges[i][2]) ? blueColor[0] : redColor[0];
				
				newline = L.polyline([[sidewalk1[0], sidewalk1[1]], [sidewalk2[0], sidewalk2[1]]], {color: lineColor, interactive: true, weight: 4});
				newline.edgeIndex = i;
				newline.on('click', function() {
					var thisIndex = Number(this);
					populateEdge(thisIndex);
				}.bind(i));
				
				polylines.push(newline);
			}
			
			lineGroup = L.layerGroup(polylines);
			lineGroup.addTo(map);
			setLineColor(1);
		}
		
		function degreesToRadians(degrees) 
		{
			return degrees * Math.PI / 180;
		}
		
		function getDistance(pos1, pos2)
		{
			var earthRadiusFeet = 6371 * 1000 * 3.28084;

			var dLat = degreesToRadians(pos2[0]-pos1[0]);
			var dLon = degreesToRadians(pos2[1]-pos1[1]);

			var tlat1 = degreesToRadians(pos1[0]);
			var tlat2 = degreesToRadians(pos2[0]);
			var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(tlat1) * Math.cos(tlat2); 
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
			
			return earthRadiusFeet * c;
		}
		
		function populateEdge(index)
		{
			console.log(lineGroup.getLayers().length);
			document.getElementById('edgeID').value = index;
			document.getElementById('edgeLength').value = edges[index][3];
			document.getElementById('edgeStart').value = edges[index][0];
			document.getElementById('edgeEnd').value = edges[index][1];
			document.getElementById('edgeAccess').checked = edges[index][2];
		}
		
		function swapTiles()
		{
			var newIndex = 1;
			
			if(showSat)
			{
				map.removeLayer(mapView);
				map.addLayer(satView);
				
				newIndex = 0;
			}
			else
			{
				map.removeLayer(satView);
				map.addLayer(mapView);
			}
			
			showSat = !showSat;
			
			setLineColor(newIndex);
		}
		
		function setLineColor(newIndex)
		{
			var oldIndex = 1 - newIndex;
			
			lineGroup.eachLayer(function(layer) {
				if(layer.options.color === blueColor[oldIndex])
				{
					layer.setStyle({color: blueColor[newIndex]});
				}
				else if(layer.options.color === redColor[oldIndex])
				{
					layer.setStyle({color: redColor[newIndex]});
				}
			});
		}
		
		function updateEdge()
		{
			var id = document.getElementById('edgeID').value;
			
			if(id.length === 0)
			{
				console.log(id);
			}
			else
			{
				id = parseInt(id);
			}
		}
		
		function estimateLength()
		{
			var id = document.getElementById('edgeID').value;
			
			if(id.length === 0)
			{
				return;
			}
			
			var startIndex = document.getElementById("edgeStart").value;
			var endIndex = document.getElementById("edgeEnd").value;
			
			if(startIndex.length === 0 || endIndex.length === 0)
			{
				return;
			}
			
			var distance = getDistance(sidewalks[edges[id][0]], sidewalks[edges[id][1]]) / 1000.0;
			
			var x1 = distance * 5.5687;
			var x2 = (edges[id][2]) ? 0 : distance * 1.3085;
			
			var z = x1 + x2;
			z = Math.floor(z * 60);
			
			document.getElementById("edgeLength").value = z;
		}
		
		function deleteEdge()
		{
			var id = document.getElementById('edgeID').value;
			
			if(id.length === 0)
			{
				return;
			}
			
			lineGroup.eachLayer(function(layer) {
				if(layer.edgeIndex == id)
				{
					var result = confirm("Are you sure you want to delete this edge?");
					
					if(result == true)
					{
						map.removeLayer(layer);
						document.getElementById('edgeID').value = "";
						document.getElementById('edgeLength').value = "";
						document.getElementById('edgeStart').value = "";
						document.getElementById('edgeEnd').value = "";
						document.getElementById('edgeAccess').checked = false;
						edges.splice(id, 1);
					}
				}
			});
		}
	</script>
	
	<style>
		body {
			margin: 0;
		}
		#map {
			margin: 8px;
			margin-bottom: 0px;
			height: 70%;
			width: 99%;
		}
		#footer {
			border-top: 1px solid black;
			height: 29%;
			width: 100%;
			display: flex;
		}
		.footerDiv {
			padding-left: 10px;
			width: 25%;
			border-left: 1px solid black;
			border-right: 1px solid black;
		}
		.shortBox {
			width: 20%;
		}
	</style>
</head>
<body onload="initMap();">
	<div id="map">
	</div>
	<div id="footer">
		<div class="footerDiv" id="div1">
			<input id='sidewalkID' type='hidden'/>
			<p>Add/Edit Sidewalk</p>
			<p>Latitude: <input type='text' /> </p>
			<p>Longitude: <input type='text' /> </p>
			<button>Save</button>
			<button>Delete</button>
		</div>
		<div class="footerDiv" id="div2">
			<input id='edgeID' type='hidden'/>
			<p>Add/Edit Edge</p>			
			<p>Starting <input class='shortBox' id='edgeStart' type='number' />
			Ending <input class='shortBox' id='edgeEnd' type='number' /> </p>
			<p>Length in seconds <input id='edgeLength' class='shortBox' type='number' /> <button onclick='estimateLength();'>Estimate?</button></p>
			<p>Accessible? <input id='edgeAccess' type='checkbox' /> </p>
			<button onclick='updateEdge();'>Save</button>
			<button onclick='deleteEdge();'>Delete</button>
		</div>
		<div class="footerDiv" id="div3">
			<input id='connectionID' type='hidden'/>
			<p>Add/Edit Connection</p>
			<p>Feature <input class='shortBox' type='number' /> 
			Sidewalk <input class='shortBox' type='number' /> </p>
			<p>Accessible? <input type='checkbox' /> </p>
			<button>Save</button>
			<button>Delete</button>
		</div>
		<div class="footerDiv" id="div4">
			<p>Controls</p>
			<button onclick="swapTiles();">Swap Tiles</button>
			<button>Save to File</button>
		</div>
		
	</div>
</body>
</html>