<html>
<head>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css">
	<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
	<script src="sidewalks.js"></script>
	<script src="features.js"></script>
	
	<script>
		var map;
		var mapView;
		var satView;
		var showSat;
		var edgeGroup;
		var connectGroup;
		var sidewalkGroup;
		var colorIndex;
		
		var blueColor = ['aqua', 'blue'];
		var redColor = ['crimson', 'red'];
		
		function initMap()
		{
			map = L.map('map', {
				center: [35.9738346, -78.8982177],
				zoom: 16,
				minZoom: 15,
				zoomControl: false
			});
		
			map.removeControl(map.attributionControl);
		
			mapView = L.tileLayer('https://maps.heigit.org/openmapsurfer/tiles/roads/webmercator/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: 'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			});

			satView = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom: 20,
				attribution: 'Imagery Â© <a href="https://www.mapbox.com/" target="_blank">Mapbox</a>',
				id: 'mapbox.satellite'
			});
		
			map.addLayer(mapView);
			
			colorIndex = 1;
			showSat = true;
			edgeGroup = new L.layerGroup();
			connectGroup = new L.layerGroup();
			sidewalkGroup = new L.layerGroup();
			
			toggleEdges();
			toggleConnections();
		}
		
		function toggleEdges()
		{
			if(edgeGroup.getLayers().length > 1)
			{
				edgeGroup.eachLayer(function(layer) {
					map.removeLayer(layer);
				});
				
				edgeGroup = new L.layerGroup();
			}
			else
			{
				var polylines = [];
			
				for(var i = 0; i < edges.length; i++)
				{
					var sidewalk1 = sidewalks[edges[i][0]];
					var sidewalk2 = sidewalks[edges[i][1]];
			
					var newline;
				
					var lineColor = (edges[i][2]) ? blueColor[0] : redColor[0];
				
					newline = L.polyline([[sidewalk1[0], sidewalk1[1]], [sidewalk2[0], sidewalk2[1]]], {color: lineColor, interactive: true, weight: 4});
					newline.edgeIndex = i;
					newline.on('click', function() {
						var thisIndex = Number(this);
						populateEdge(thisIndex);
					}.bind(i));
				
					polylines.push(newline);
				}
			
				edgeGroup = L.layerGroup(polylines);
				edgeGroup.addTo(map);
				setEdgeColor(colorIndex);
			}
		}
		
		function toggleConnections()
		{
			if(connectGroup.getLayers().length > 1)
			{
				connectGroup.eachLayer(function(layer) {
					map.removeLayer(layer);
				});
				
				connectGroup = new L.layerGroup();
			}
			else
			{
				var polylines = [];
				for(var i = 0; i < connections.length; i++)
				{
					var sidewalkIndex = connections[i][0];
					var locationIndex = connections[i][1];
		
					var sidewalk = sidewalks[sidewalkIndex];
					var location = features[locationIndex];

					var lineColor = (connections[i][2]) ? blueColor[0] : redColor[0];
					var newline = L.polyline([[sidewalk[0], sidewalk[1]], [location[0], location[1]]], {color: lineColor, interactive: true, weight: 4}).addTo(map);	
					newline.connectIndex = i;
					newline.on('click', function() {
						var thisIndex = Number(this);
						populateConnection(thisIndex);
					}.bind(i));
					polylines.push(newline);
				}
				
				connectGroup = L.layerGroup(polylines);
				connectGroup.addTo(map);
				setConnectColor(colorIndex);
			}
		}
		function degreesToRadians(degrees) 
		{
			return degrees * Math.PI / 180;
		}
		
		function getDistance(pos1, pos2)
		{
			var earthRadiusFeet = 6371 * 1000 * 3.28084;

			var dLat = degreesToRadians(pos2[0]-pos1[0]);
			var dLon = degreesToRadians(pos2[1]-pos1[1]);

			var tlat1 = degreesToRadians(pos1[0]);
			var tlat2 = degreesToRadians(pos2[0]);
			var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(tlat1) * Math.cos(tlat2); 
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
			
			return earthRadiusFeet * c;
		}
		
		function populateConnection(index)
		{
			document.getElementById('connectionID').value = index;
			document.getElementById('connectStart').value = connections[index][0];
			document.getElementById('connectEnd').value = connections[index][1];
			document.getElementById('connectAccess').checked = connections[index][2];
		}
		
		function populateEdge(index)
		{
			document.getElementById('edgeID').value = index;
			document.getElementById('edgeLength').value = edges[index][3];
			document.getElementById('edgeStart').value = edges[index][1];
			document.getElementById('edgeEnd').value = edges[index][0];
			document.getElementById('edgeAccess').checked = edges[index][2];
		}
		
		function swapTiles()
		{
			colorIndex = 1;
			
			if(showSat)
			{
				map.removeLayer(mapView);
				map.addLayer(satView);
				
				colorIndex = 0;
			}
			else
			{
				map.removeLayer(satView);
				map.addLayer(mapView);
			}
			
			showSat = !showSat;
			
			setEdgeColor(colorIndex);
			setConnectColor(colorIndex);
		}
		
		function setEdgeColor(newIndex)
		{
			var oldIndex = 1 - newIndex;
			
			edgeGroup.eachLayer(function(layer) {
				if(layer.options.color === blueColor[oldIndex])
				{
					layer.setStyle({color: blueColor[newIndex]});
				}
				else if(layer.options.color === redColor[oldIndex])
				{
					layer.setStyle({color: redColor[newIndex]});
				}
			});
		}
		
		function setConnectColor(newIndex)
		{
			var oldIndex = 1 - newIndex;
			
			connectGroup.eachLayer(function(layer) {
				if(layer.options.color === blueColor[oldIndex])
				{
					layer.setStyle({color: blueColor[newIndex]});
				}
				else if(layer.options.color === redColor[oldIndex])
				{
					layer.setStyle({color: redColor[newIndex]});
				}
			});
		}
		
		function updateEdge()
		{
			var id = document.getElementById('edgeID').value;
			
			if(id.length === 0)
			{
				return;
			}

			var startIndex = document.getElementById("edgeStart").value;
			var endIndex = document.getElementById("edgeEnd").value;
			var edgeAccess = document.getElementById('edgeAccess').checked;
			var edgeLength = document.getElementById("edgeLength").value;
			
			edges[id] = [startIndex, endIndex, edgeAccess, edgeLength];
		}
		
		function estimateLength()
		{
			var id = document.getElementById('edgeID').value;
			
			if(id.length === 0)
			{
				return;
			}
			
			var startIndex = document.getElementById("edgeStart").value;
			var endIndex = document.getElementById("edgeEnd").value;
			
			if(startIndex.length === 0 || endIndex.length === 0)
			{
				return;
			}
			
			var distance = getDistance(sidewalks[edges[id][0]], sidewalks[edges[id][1]]) / 1000.0;
			
			var x1 = distance * 5.5687;
			var x2 = (edges[id][2]) ? 0 : distance * 1.3085;
			
			var z = x1 + x2;
			z = Math.floor(z * 60);
			
			document.getElementById("edgeLength").value = z;
		}
		
		function toggleSidewalks()
		{
			if(sidewalkGroup.getLayers().length > 1)
			{
				sidewalkGroup.eachLayer(function(layer) {
					map.removeLayer(layer);
				});
				
				sidewalkGroup = new L.layerGroup();
			}
			else
			{
				for(var i = 0; i < sidewalks.length; i++)
				{
					var sidewalk = sidewalks[i];
			
					var marker = L.circleMarker([sidewalk[0], sidewalk[1]], {radius: 8, color: '#7a00cc'});
					marker.bindPopup(" " + i);
					marker.addTo(map);
					sidewalkGroup.addLayer(marker);
				}			
			}
		}
		
		function deleteEdge()
		{
			var id = document.getElementById('edgeID').value;
			
			if(id.length === 0)
			{
				return;
			}
			
			edgeGroup.eachLayer(function(layer) {
				if(layer.edgeIndex == id)
				{
					var result = confirm("Are you sure you want to delete this edge?");
					
					if(result == true)
					{
						map.removeLayer(layer);
						document.getElementById('edgeID').value = "";
						document.getElementById('edgeLength').value = "";
						document.getElementById('edgeStart').value = "";
						document.getElementById('edgeEnd').value = "";
						document.getElementById('edgeAccess').checked = false;
						edges.splice(id, 1);
					}
				}
			});
		}
	</script>
	
	<style>
		body {
			margin: 0;
		}
		#map {
			margin: 8px;
			margin-bottom: 0px;
			height: 70%;
			width: 99%;
		}
		#footer {
			border-top: 1px solid black;
			height: 29%;
			width: 100%;
			display: flex;
		}
		.footerDiv {
			padding-left: 10px;
			width: 25%;
			border-left: 1px solid black;
			border-right: 1px solid black;
		}
		.buttonColumn {
			width: 45%;
			margin: 5px;
			height: 15%;
		}
		.footerDivHeader {
			text-align: center;
			font-size: 20px;
			margin-top: 8px;
		}
		#edgeLength {
			width: 25%;
		}
	</style>
</head>
<body onload="initMap();">
	<div id="map">
	</div>
	<div id="footer">
		<div class="footerDiv" id="div1">
			<input id='sidewalkID' type='hidden'/>
			<p class='footerDivHeader'>Edit Sidewalk</p>
			<p>Latitude: <input type='text' /> </p>
			<p>Longitude: <input type='text' /> </p>
			<button class='buttonColumn'>Save</button>
			<button class='buttonColumn'>Delete</button>
		</div>
		<div class="footerDiv" id="div2">
			<input id='edgeID' type='hidden'/>
			<p class='footerDivHeader'>Edit Edge</p>			
			<p>Starting <input id='edgeStart' type='number' /></p>
			<p>Ending <input  id='edgeEnd' type='number' /> </p>
			<p>Length in seconds <input id='edgeLength' type='number' /> <button onclick='estimateLength();'>Estimate?</button></p>
			<p>Accessible? <input id='edgeAccess' type='checkbox' /> </p>
			<button class='buttonColumn' onclick='updateEdge();'>Save</button>
			<button class='buttonColumn' onclick='deleteEdge();'>Delete</button>
		</div>
		<div class="footerDiv" id="div3">
			<input id='connectionID' type='hidden'/>
			<p class='footerDivHeader'>Edit Connection</p>
			<p>Feature <input id='connectStart' type='number' /></p>
			<p>Sidewalk <input id='connectEnd' type='number' /> </p>
			<p>Accessible? <input id='connectAccess' type='checkbox' /> </p>
			<button class='buttonColumn'>Save</button>
			<button class='buttonColumn'>Delete</button>
		</div>
		<div class="footerDiv" id="div4">
			<p class='footerDivHeader'>Controls</p>
			<button class='buttonColumn' onclick='toggleSidewalks();'>Toggle sidewalks</button>
			<button class='buttonColumn'>Add sidewalk</button>
			<button class='buttonColumn' onclick='toggleEdges();'>Toggle edges</button>
			<button class='buttonColumn'>Add edge</button>
			<button class='buttonColumn' onclick='toggleConnections();'>Toggle connections</button>
			<button class='buttonColumn'>Add connection</button>
			<button class='buttonColumn' onclick="swapTiles();">Swap Tiles</button>
			<button class='buttonColumn'>Save to File</button>
		</div>		
	</div>
</body>
</html>